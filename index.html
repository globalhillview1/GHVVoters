<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Voters</title>
  <style>
    :root { --bg:#0b1020; --card:#121833; --muted:#aab3d0; --txt:#eaf0ff; --accent:#6ea8fe; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji"; background: var(--bg); color: var(--txt); }
    header { padding: 20px clamp(16px, 3vw, 32px); display:flex; gap:16px; align-items:center; justify-content:space-between; position:sticky; top:0; backdrop-filter: blur(6px); background: color-mix(in oklab, var(--bg) 70%, transparent); border-bottom: 1px solid #1f2748; z-index: 10;}
    .brand { font-weight:700; letter-spacing:.3px; display:flex; gap:10px; align-items:center;}
    .brand small { color: var(--muted); font-weight:500; }
    .toolbar { display:flex; gap:10px; flex-wrap:wrap; }
    input[type="search"], select { background: var(--card); color: var(--txt); border: 1px solid #263057; border-radius: 10px; padding: 10px 12px; outline:none; }
    input[type="search"]::placeholder { color: #9aa6d1; }
    .chip { padding:10px 12px; background: var(--card); border:1px solid #263057; border-radius:10px; color: var(--muted); }
    .container { padding: 18px clamp(12px, 3vw, 32px) 40px; }
    .tablewrap { overflow:auto; border: 1px solid #263057; border-radius: 14px; background: var(--card); }
    table { width: 100%; border-collapse: collapse; font-size: 14px; min-width: 900px; }
    thead th { position: sticky; top: 0; background: #161e3c; color: #cfd7ff; text-align: left; padding: 12px 10px; border-bottom: 1px solid #263057; }
    tbody td { padding: 10px; border-bottom: 1px dashed #223058; }
    tbody tr:hover { background: #10183a; }
    .sortable { cursor: pointer; user-select: none; }
    .sort-ind { opacity: .7; font-size: 12px; padding-left: 6px; }
    .muted { color: var(--muted); }
    .grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:10px; }
    .pager { display:flex; gap:8px; align-items:center; justify-content:flex-end; padding: 10px 2px; }
    .btn { background:#1b2550; border:1px solid #2a3770; color:var(--txt); padding:8px 12px; border-radius:10px; cursor:pointer; }
    .btn[disabled] { opacity:.5; cursor:not-allowed; }
    @media (max-width: 700px) {
      header { flex-direction: column; align-items: stretch; gap: 12px; }
      .pager { justify-content: center; }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div>üó≥Ô∏è Voters</div>
      <small id="meta" class="muted"></small>
    </div>
    <div class="toolbar">
      <input id="q" type="search" placeholder="Quick search..." />
      <select id="sortBy"></select>
      <select id="sortDir">
        <option value="asc">‚ñ≤ Asc</option>
        <option value="desc">‚ñº Desc</option>
      </select>
      <select id="pageSize">
        <option>25</option><option>50</option><option selected>100</option><option>250</option>
      </select>
      <span class="chip" id="totalChip">‚Äì rows</span>
    </div>
  </header>

  <div class="container">
    <div class="tablewrap">
      <table id="tbl">
        <thead>
          <tr id="theadRow"></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="pager">
      <button class="btn" id="prevBtn">Prev</button>
      <span class="muted" id="pageInfo"></span>
      <button class="btn" id="nextBtn">Next</button>
    </div>
  </div>

<script>
  // ---- CONFIG ----
  const API_BASE = 'https://script.google.com/macros/s/AKfycby5tqQAlF7k3jfLs5sKkHjt3Er5qLUOJKrBIpXVHZYG4fjiahRqtKLE10drur2iXlB5Ow/exec'; // e.g., https://script.google.com/macros/s/AKfycb.../exec
  const ROUTE = 'voters';
  const DEFAULT_COLUMNS = [
    'Tower No.', 'Flat No.', 'First Owner Name', 'Second Owner Name',
    'Membership Card & Share Certificate No', 'Eligible Voter', 'Discrepency', 'Voted Earlier'
  ];

  // ---- STATE ----
  let state = {
    q: '',
    sort: '',
    dir: 'asc',
    page: 1,
    limit: 100,
    total: 0,
    columns: [...DEFAULT_COLUMNS],
    rows: []
  };

  // ---- DOM ----
  const qEl = document.getElementById('q');
  const sortByEl = document.getElementById('sortBy');
  const sortDirEl = document.getElementById('sortDir');
  const pageSizeEl = document.getElementById('pageSize');
  const theadRow = document.getElementById('theadRow');
  const tbody = document.getElementById('tbody');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const pageInfo = document.getElementById('pageInfo');
  const totalChip = document.getElementById('totalChip');
  const meta = document.getElementById('meta');

  function qs(params) {
    const u = new URL(API_BASE);
    u.searchParams.set('route', ROUTE);
    u.searchParams.set('v', '1');
    if (state.q) u.searchParams.set('q', state.q);
    if (state.sort) u.searchParams.set('sort', state.sort);
    if (state.dir) u.searchParams.set('dir', state.dir);
    u.searchParams.set('page', state.page);
    u.searchParams.set('limit', state.limit);
    return u.toString();
  }

  async function fetchRows() {
    tbody.innerHTML = `<tr><td class="muted" colspan="${state.columns.length}">Loading‚Ä¶</td></tr>`;
    try {
      const res = await fetch(qs(), { method: 'GET', mode: 'cors' });
      const data = await res.json();

      if (!data.ok) throw new Error(data.error || 'API error');

      state.total = data.total;
      state.rows = data.rows;

      renderHead(data.rows[0] ? Object.keys(data.rows[0]) : state.columns);
      renderBody();
      renderPager();
      totalChip.textContent = `${state.total} rows`;
      meta.textContent = `page ${state.page}`;
    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="${state.columns.length}" style="color:#f99">Failed to load: ${err.message}</td></tr>`;
    }
  }

  function renderHead(cols) {
    state.columns = cols;
    theadRow.innerHTML = '';
    sortByEl.innerHTML = '<option value="">(No sort)</option>';
    cols.forEach(col => {
      // header cells (clickable sort)
      const th = document.createElement('th');
      th.className = 'sortable';
      th.textContent = col;
      if (state.sort === col) {
        const span = document.createElement('span');
        span.className = 'sort-ind';
        span.textContent = state.dir === 'asc' ? '‚ñ≤' : '‚ñº';
        th.appendChild(span);
      }
      th.addEventListener('click', () => {
        if (state.sort === col) {
          state.dir = state.dir === 'asc' ? 'desc' : 'asc';
        } else {
          state.sort = col;
          state.dir = 'asc';
        }
        state.page = 1;
        fetchRows();
      });
      theadRow.appendChild(th);

      // sort dropdown
      const opt = document.createElement('option');
      opt.value = col;
      opt.textContent = col;
      if (state.sort === col) opt.selected = true;
      sortByEl.appendChild(opt);
    });
  }

  function renderBody() {
    tbody.innerHTML = '';
    if (!state.rows.length) {
      tbody.innerHTML = `<tr><td class="muted" colspan="${state.columns.length}">No results</td></tr>`;
      return;
    }
    for (const row of state.rows) {
      const tr = document.createElement('tr');
      state.columns.forEach(col => {
        const td = document.createElement('td');
        let v = row[col];
        // Pretty booleans like "Yes"
        if (String(v).toLowerCase() === 'yes') {
          td.textContent = 'Yes';
        } else if (String(v).toLowerCase() === 'no') {
          td.textContent = 'No';
        } else {
          td.textContent = v === undefined || v === null ? '' : v;
        }
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    }
  }

  function renderPager() {
    const pages = Math.max(1, Math.ceil(state.total / state.limit));
    pageInfo.textContent = `Page ${state.page} of ${pages}`;
    prevBtn.disabled = state.page <= 1;
    nextBtn.disabled = state.page >= pages;
  }

  // ---- Events ----
  qEl.addEventListener('input', debounce(() => { state.q = qEl.value.trim(); state.page = 1; fetchRows(); }, 250));
  sortByEl.addEventListener('change', () => { state.sort = sortByEl.value; state.page = 1; fetchRows(); });
  sortDirEl.addEventListener('change', () => { state.dir = sortDirEl.value; state.page = 1; fetchRows(); });
  pageSizeEl.addEventListener('change', () => { state.limit = parseInt(pageSizeEl.value, 10); state.page = 1; fetchRows(); });
  prevBtn.addEventListener('click', () => { if (state.page > 1) { state.page--; fetchRows(); } });
  nextBtn.addEventListener('click', () => { state.page++; fetchRows(); });

  function debounce(fn, ms) {
    let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn.apply(null, args), ms); };
  }

  // ---- init ----
  fetchRows();
</script>
</body>
</html>
