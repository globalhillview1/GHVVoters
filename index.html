<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Voters</title>
<style>
  :root { --bg:#0b1020; --card:#121833; --muted:#aab3d0; --txt:#eaf0ff; }
  *{ box-sizing:border-box }
  body{ margin:0; font-family:ui-sans-serif,system-ui,"Segoe UI",Roboto,Helvetica,Arial; background:var(--bg); color:var(--txt) }
  header{ padding:20px clamp(16px,3vw,32px); display:flex; gap:16px; align-items:center; justify-content:space-between; position:sticky; top:0; backdrop-filter: blur(6px); background:#0b1020cc; border-bottom:1px solid #1f2748; z-index:10 }
  .brand{ font-weight:700; display:flex; gap:10px; align-items:center }
  .brand small{ color:var(--muted) }
  .toolbar{ display:flex; gap:10px; flex-wrap:wrap }
  input[type="search"], select{ background:var(--card); color:var(--txt); border:1px solid #263057; border-radius:10px; padding:10px 12px; outline:none }
  input[type="search"]::placeholder{ color:#9aa6d1 }
  .chip{ padding:10px 12px; background:var(--card); border:1px solid #263057; border-radius:10px; color:var(--muted) }
  .container{ padding:18px clamp(12px,3vw,32px) 40px }
  .section{ background:#0f1734; border:1px solid #233160; border-radius:16px; padding:16px; margin-bottom:18px }
  .section h2{ margin:0 0 12px; font-size:20px; color:#e5ecff; display:flex; gap:8px; align-items:center }
  .section h2::before{ content:"üìä" }
  .cards{ display:grid; grid-template-columns:repeat(6,minmax(140px,1fr)); gap:14px }
  @media (max-width:1200px){ .cards{ grid-template-columns:repeat(3,1fr) } }
  @media (max-width:640px){ .cards{ grid-template-columns:repeat(2,1fr) } }
  .card{ border-radius:14px; padding:16px; text-align:center; background:linear-gradient(135deg,#5b79ff 0%,#7a4de0 100%); color:white; box-shadow:0 6px 20px rgba(20,30,70,.25) }
  .card .k{ font-size:15px; font-weight:700; opacity:.95 }
  .card .v{ font-size:28px; font-weight:800; margin-top:6px }

  .tablewrap{ overflow:auto; border:1px solid #263057; border-radius:14px; background:var(--card) }
  table{ width:100%; border-collapse:collapse; font-size:14px; min-width:1000px }
  thead th{ position:sticky; top:0; background:#161e3c; color:#cfd7ff; text-align:left; padding:12px 10px; border-bottom:1px solid #263057 }
  tbody td{ padding:10px; border-bottom:1px dashed #223058; vertical-align:top }
  tbody tr:hover{ background:#10183a }
  .sortable{ cursor:pointer; user-select:none }
  .sort-ind{ opacity:.7; font-size:12px; padding-left:6px }

  .actions{ white-space:nowrap }
  .btn{ background:#1b2550; border:1px solid #2a3770; color:var(--txt); padding:6px 10px; border-radius:8px; cursor:pointer; font-size:12px; }
  .btn:disabled{ opacity:.6; cursor:not-allowed }
  .muted{ color:var(--muted) }
  .pager{ display:flex; gap:8px; align-items:center; justify-content:flex-end; padding:10px 2px }
  @media (max-width:700px){ header{ flex-direction:column; align-items:stretch; gap:12px } .pager{ justify-content:center } }
  .remark-input{ width:100%; background:#0f1530; color:#fff; border:1px solid #2a3770; border-radius:8px; padding:6px 8px }
</style>
</head>
<body>
<header>
  <div class="brand">üó≥Ô∏è Voters <small id="meta" class="muted"></small></div>
  <div class="toolbar">
    <input id="q" type="search" placeholder="Quick search..." />
    <select id="sortBy"></select>
    <select id="sortDir"><option value="asc">‚ñ≤ Asc</option><option value="desc">‚ñº Desc</option></select>
    <select id="pageSize"><option>25</option><option>50</option><option selected>100</option><option>250</option></select>
    <span class="chip" id="totalChip">‚Äì rows</span>
  </div>
</header>

<div class="container">
  <div class="section">
    <h2>Summary Statistics</h2>
    <div class="cards" id="cards"></div>
  </div>

  <div class="tablewrap">
    <table id="tbl">
      <thead><tr id="theadRow"></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
  <div class="pager">
    <button class="btn" id="prevBtn">Prev</button>
    <span class="muted" id="pageInfo"></span>
    <button class="btn" id="nextBtn">Next</button>
  </div>
</div>

<script>
  // ---- CONFIG ----
  const API_BASE = 'https://script.google.com/macros/s/AKfycby5tqQAlF7k3jfLs5sKkHjt3Er5qLUOJKrBIpXVHZYG4fjiahRqtKLE10drur2iXlB5Ow/exec'; // https://script.google.com/macros/s/AKfycb.../exec
  const ROUTE = 'voters';

  // Include Remark + an Actions column
  const DEFAULT_COLUMNS = [
    'Tower No.','Flat No.','First Owner Name','Second Owner Name',
    'Membership Card & Share Certificate No','Eligible Voter','Discrepency','Voted Earlier','Remark'
  ];

  // ---- STATE ----
  let state = {
    q:'', sort:'', dir:'asc', page:1, limit:100,
    total:0, columns:[...DEFAULT_COLUMNS], rows:[],
    summary:{T1:0,T2:0,T3:0,T4:0,T5:0,total:0}
  };

  // ---- DOM ----
  const qEl = document.getElementById('q');
  const sortByEl = document.getElementById('sortBy');
  const sortDirEl = document.getElementById('sortDir');
  const pageSizeEl = document.getElementById('pageSize');
  const theadRow = document.getElementById('theadRow');
  const tbody = document.getElementById('tbody');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const pageInfo = document.getElementById('pageInfo');
  const totalChip = document.getElementById('totalChip');
  const meta = document.getElementById('meta');
  const cards = document.getElementById('cards');

  function urlWithParams() {
    const u = new URL(API_BASE);
    u.searchParams.set('route', ROUTE);
    u.searchParams.set('v', '1');
    if (state.q)   u.searchParams.set('q', state.q);
    if (state.sort)u.searchParams.set('sort', state.sort);
    if (state.dir) u.searchParams.set('dir', state.dir);
    u.searchParams.set('page', state.page);
    u.searchParams.set('limit', state.limit);
    return u.toString();
  }

  async function fetchRows() {
    tbody.innerHTML = `<tr><td class="muted" colspan="${state.columns.length+1}">Loading‚Ä¶</td></tr>`;
    try {
      const res = await fetch(urlWithParams(), { method:'GET', mode:'cors' });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || 'API error');

      state.total = data.total;
      state.rows = data.rows || [];
      state.summary = data.summary || state.summary;

      renderSummary();
      renderHead(state.rows[0] ? Object.keys(state.rows[0]) : state.columns);
      renderBody();
      renderPager();
      totalChip.textContent = `${state.total} rows`;
      meta.textContent = `page ${state.page}`;
    } catch (err) {
      tbody.innerHTML = `<tr><td colspan="${state.columns.length+1}" style="color:#f99">Failed to load: ${err.message}</td></tr>`;
    }
  }

  function renderSummary() {
    const s = state.summary || {};
    const items = [
      ['Tower T1', s.T1||0],['Tower T2', s.T2||0],['Tower T3', s.T3||0],
      ['Tower T4', s.T4||0],['Tower T5', s.T5||0],['Total Flats', s.total||0],
    ];
    cards.innerHTML = items.map(([k,v]) => `
      <div class="card"><div class="k">${k}</div><div class="v">${v}</div></div>
    `).join('');
  }

  function renderHead(cols) {
    // add our columns (Remark included) and one extra "Actions" header
    state.columns = cols;
    if (!state.columns.includes('Remark')) state.columns.push('Remark');

    theadRow.innerHTML = '';
    sortByEl.innerHTML = '<option value="">(No sort)</option>';

    state.columns.concat(['Actions']).forEach(col => {
      const th = document.createElement('th');
      if (col !== 'Actions') {
        th.className = 'sortable';
        th.textContent = col;
        if (state.sort === col) {
          const span = document.createElement('span'); span.className='sort-ind';
          span.textContent = state.dir === 'asc' ? '‚ñ≤' : '‚ñº'; th.appendChild(span);
        }
        th.addEventListener('click', () => {
          if (state.sort === col) { state.dir = state.dir === 'asc' ? 'desc' : 'asc'; }
          else { state.sort = col; state.dir = 'asc'; }
          state.page = 1; fetchRows();
        });
        const opt = document.createElement('option'); opt.value = col; opt.textContent = col;
        if (state.sort === col) opt.selected = true; sortByEl.appendChild(opt);
      } else {
        th.textContent = 'Actions';
      }
      theadRow.appendChild(th);
    });
  }

  function renderBody() {
    tbody.innerHTML = '';
    if (!state.rows.length) {
      tbody.innerHTML = `<tr><td class="muted" colspan="${state.columns.length+1}">No results</td></tr>`;
      return;
    }

    for (const row of state.rows) {
      const tr = document.createElement('tr');
      for (const col of state.columns) {
        const td = document.createElement('td');
        td.dataset.col = col;
        td.textContent = (row[col] ?? '') + '';
        tr.appendChild(td);
      }

      // Actions cell (edit/save cancel for Remark only)
      const act = document.createElement('td');
      act.className = 'actions';
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.textContent = '‚úèÔ∏è Edit Remark';
      btn.addEventListener('click', () => enterEditRemark(tr, row));
      act.appendChild(btn);
      tr.appendChild(act);

      tbody.appendChild(tr);
    }
  }

  function enterEditRemark(tr, row) {
    const remarkTd = tr.querySelector('td[data-col="Remark"]');
    if (!remarkTd) return;

    const original = remarkTd.textContent || '';
    remarkTd.innerHTML = `<input class="remark-input" value="${escapeHtmlAttr(original)}" />`;
    const input = remarkTd.querySelector('input');

    const actTd = tr.lastElementChild;
    actTd.innerHTML = '';

    const saveBtn = document.createElement('button');
    saveBtn.className = 'btn'; saveBtn.textContent = 'üíæ Save';
    saveBtn.addEventListener('click', async () => {
      saveBtn.disabled = true;
      const ok = await saveRemark(row['Tower No.'], row['Flat No.'], input.value);
      saveBtn.disabled = false;
      if (ok) { remarkTd.textContent = input.value; restoreActions(actTd, tr, row); }
      else { alert('Failed to save Remark'); }
    });

    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'btn'; cancelBtn.style.marginLeft = '6px'; cancelBtn.textContent = '‚Ü©Ô∏é Cancel';
    cancelBtn.addEventListener('click', () => { remarkTd.textContent = original; restoreActions(actTd, tr, row); });

    actTd.appendChild(saveBtn);
    actTd.appendChild(cancelBtn);
    input.focus();
  }

  function restoreActions(actTd, tr, row) {
    actTd.innerHTML = '';
    const btn = document.createElement('button');
    btn.className = 'btn'; btn.textContent = '‚úèÔ∏è Edit Remark';
    btn.addEventListener('click', () => enterEditRemark(tr, row));
    actTd.appendChild(btn);
  }

  async function saveRemark(tower, flat, remark) {
    try {
      const body = new URLSearchParams();
      body.set('route', 'updateRemark');
      body.set('tower', String(tower ?? ''));
      body.set('flat', String(flat ?? ''));
      body.set('remark', remark ?? '');

      const res = await fetch(API_BASE, {
        method: 'POST',
        mode: 'cors',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body
      });
      const data = await res.json();
      return !!data.ok;
    } catch (e) {
      console.error(e);
      return false;
    }
  }

  // util
  function escapeHtmlAttr(s){ return String(s).replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }

  function renderPager() {
    const pages = Math.max(1, Math.ceil(state.total / state.limit));
    pageInfo.textContent = `Page ${state.page} of ${pages}`;
    prevBtn.disabled = state.page <= 1;
    nextBtn.disabled = state.page >= pages;
  }

  // events
  qEl.addEventListener('input', debounce(() => { state.q = qEl.value.trim(); state.page = 1; fetchRows(); }, 250));
  sortByEl.addEventListener('change', () => { state.sort = sortByEl.value; state.page = 1; fetchRows(); });
  sortDirEl.addEventListener('change', () => { state.dir = sortDirEl.value; state.page = 1; fetchRows(); });
  pageSizeEl.addEventListener('change', () => { state.limit = parseInt(pageSizeEl.value,10); state.page = 1; fetchRows(); });
  prevBtn.addEventListener('click', () => { if (state.page > 1) { state.page--; fetchRows(); } });
  nextBtn.addEventListener('click', () => { state.page++; fetchRows(); });

  function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

  // init
  fetchRows();
</script>
</body>
</html>
